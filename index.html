<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GWBasic with File Download</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://v8.js-dos.com/latest/js-dos.css">
<script src="https://v8.js-dos.com/latest/js-dos.js"></script>
<style>
  html, body { margin:0; padding:0; width:100%; height:100%; background:black; overflow:hidden; font-family:'Courier New', monospace; display:flex; flex-direction:column; }
  #dos-root { flex:1; border-bottom:2px solid #444; width:100%; }
  #keyboard-container {
    width:100%;
    background:#222;
    display:flex;
    flex-direction:stretch;
    align-items:center;
    padding:4px;
    box-sizing:border-box;
  }
  .key-row {
    display:flex;
    justify-content:center;
    gap:4px;
    width:100%;
    padding:2px 0;
  }
  .key {
    background:#444;
    color:white;
    font-size:1em;
    padding:10px;
    border-radius:6px;
    cursor:pointer;
    user-select:none;
    text-align:center;
    flex: 1 1 auto; 
    min-width: 28px;
    max-width: 1fr;
  }
  .key:hover { background:#666; }
  .key:active { background:#888; transform:translateY(1px); }
  .key.wide { flex:2 1 auto; }
  .key.special { background:#5a3c1c; }
  .key.shift-active { background:#c96 !important; }
  #downloadBtn {
    background:#28a745;
    color:white;
    font-size:1em;
    padding:6px 12px;
    border:none;
    border-radius:3px;
    cursor:pointer;
    margin:3px;
    transition: all 0.2s ease-in-out;
  }
  #downloadBtn:disabled {
    background:#6c757d;
    color:#ddd;
    cursor:default;
  }
  #downloadBtn:hover:not(:disabled) {
    background:#218838;
    transform: translateY(-1px);
  }
  /* On small screens */
@media (max-width: 600px) {
  .key {
    font-size: 0.8em;
    padding: 8px 6px;
    min-width: 22px;
  }
  .key-row {
    gap: 2px;
  }
}
/* On very small screens */
@media (max-width: 400px) {
  .key {
    font-size: 0.7em;
    padding: 6px 4px;
    min-width: 18px;
  }
} 
</style>
</head>
<body>

<div id="dos-root"></div>
<button id="downloadBtn" disabled>Download</button>

<div id="keyboard-container">
  <!-- Function keys -->
  <div class="key-row">
    <div class="key" data-key="112">F1</div>
    <div class="key" data-key="113">F2</div>
    <div class="key" data-key="114">F3</div>
    <div class="key" data-key="115">F4</div>
    <div class="key" data-key="116">F5</div>
    <div class="key" data-key="117">F6</div>
    <div class="key" data-key="118">F7</div>
    <div class="key" data-key="119">F8</div>
    <div class="key" data-key="120">F9</div>
    <div class="key" data-key="121">F10</div>
  </div>
  <!-- Number row -->
  <div class="key-row">
    <div class="key" data-key="49">1</div>
    <div class="key" data-key="50">2</div>
    <div class="key" data-key="51">3</div>
    <div class="key" data-key="52">4</div>
    <div class="key" data-key="53">5</div>
    <div class="key" data-key="54">6</div>
    <div class="key" data-key="55">7</div>
    <div class="key" data-key="56">8</div>
    <div class="key" data-key="57">9</div>
    <div class="key" data-key="48">0</div>
    <div class="key wide special" data-key="8">⌫</div>
  </div>
  <!-- QWERTY row -->
  <div class="key-row">
    <div class="key" data-key="81">Q</div>
    <div class="key" data-key="87">W</div>
    <div class="key" data-key="69">E</div>
    <div class="key" data-key="82">R</div>
    <div class="key" data-key="84">T</div>
    <div class="key" data-key="89">Y</div>
    <div class="key" data-key="85">U</div>
    <div class="key" data-key="73">I</div>
    <div class="key" data-key="79">O</div>
    <div class="key" data-key="80">P</div>
  </div>
  <!-- Home row -->
  <div class="key-row">
    <div class="key" data-key="65">A</div>
    <div class="key" data-key="83">S</div>
    <div class="key" data-key="68">D</div>
    <div class="key" data-key="70">F</div>
    <div class="key" data-key="71">G</div>
    <div class="key" data-key="72">H</div>
    <div class="key" data-key="74">J</div>
    <div class="key" data-key="75">K</div>
    <div class="key" data-key="76">L</div>
    <div class="key" data-key="186">;</div>
    <div class="key" data-key="222">'</div>
    <div class="key wide special" data-key="13">⏎</div>
  </div>
  <!-- Bottom row -->
  <div class="key-row">
    <div class="key wide special" data-key="16">⇧</div>
    <div class="key" data-key="90">Z</div>
    <div class="key" data-key="88">X</div>
    <div class="key" data-key="67">C</div>
    <div class="key" data-key="86">V</div>
    <div class="key" data-key="66">B</div>
    <div class="key" data-key="78">N</div>
    <div class="key" data-key="77">M</div>
    <div class="key" data-key="188">,</div>
    <div class="key" data-key="190">.</div>
    <div class="key" data-key="191">/</div>
  </div>
  <!-- Symbol & space row -->
  <div class="key-row">
    <div class="key wide" data-key="32">Space</div>
  </div>
</div>

<script>
const dos = Dos(document.getElementById("dos-root"), {
  url: "./basic.jsdos",
  backend: "dosboxX",
  backendLocked: false,
  autoStart: true,
  autoSave: false,
  kiosk: true,
  onEvent: async (event, ci) => {
    if (event !== "ci-ready") return;
    console.log("DOS is ready");
    try {
        await ci.fsWriteFile("output1.txt", new TextEncoder().encode(""));
        startMonitoring(ci);
    } catch (err) {
        console.error("Error in setup:", err);
    }
  },
});

async function startMonitoring(ci) {
    let lastSize = 0;
    let monitoring = true;

    async function checkOutput() {
        if (!monitoring) return;
        try {
            const data = await ci.fsReadFile("output1.txt");
            if (data && data.length > lastSize) {
                lastSize = data.length;
                enableDownload(data);
            }
        } catch (err) {
            console.log("Checking for output...");
        }
        setTimeout(() => checkOutput(), 1000);
    }

    checkOutput();
    return () => { monitoring = false; };
}

function enableDownload(data) {
  const downloadBtn = document.getElementById("downloadBtn");
  if (!data || data.length === 0) {
    downloadBtn.disabled = true;
    return;
  }
  downloadBtn.disabled = false;
  downloadBtn.onclick = () => {
    const content = new TextDecoder().decode(data)
      .replace(/\r\n/g, '\n')
      .replace(/\r/g, '\n')
      .split('\n')
      .map(line => line.trimEnd())
      .join('\n');
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "output.txt";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };
}

// --- Virtual Keyboard ---
let shiftActive = false;
let shiftLocked = false;
let lastShiftTap = 0;
const DOUBLE_TAP_THRESHOLD = 300;

function getDosCanvas() {
  return document.querySelector("#dos-root canvas");
}

const keyboard = document.getElementById("keyboard-container");
keyboard.addEventListener("click", event => {
  const keyElem = event.target.closest(".key");
  if (!keyElem) return;
  const keyCode = parseInt(keyElem.dataset.key);
  if (isNaN(keyCode)) return;

  if (keyCode === 16) handleShiftUI(keyElem);
  else handleKey(keyCode);
});
keyboard.addEventListener("touchstart", event => {
  const keyElem = event.target.closest(".key");
  if (!keyElem) return;
  keyElem.click();
}, { passive: true });
  
function updateShiftKey(keyElem) {
  if (shiftLocked || shiftActive) keyElem.classList.add("shift-active");
  else keyElem.classList.remove("shift-active");
}

function handleKey(keyCode) {
  const canvas = getDosCanvas();
  if (!canvas) return;
  const shiftElem = document.querySelector(".key[data-key='16']");

  if (shiftActive && !shiftLocked) {
    sendKey(canvas, 16); // press Shift
    sendKey(canvas, keyCode);
    releaseKey(canvas, keyCode);
    releaseKey(canvas, 16); // release Shift
    shiftActive = false;
    updateShiftKey(shiftElem);
  } else {
    sendKey(canvas, keyCode);
    releaseKey(canvas, keyCode);
  }
  updateKeyboardUI();
}

function sendKey(canvas, keyCode) {
  canvas.dispatchEvent(new KeyboardEvent("keydown", { keyCode, which: keyCode, bubbles: true }));
}

function releaseKey(canvas, keyCode) {
  canvas.dispatchEvent(new KeyboardEvent("keyup", { keyCode, which: keyCode, bubbles: true }));
}

const functionalKeys = [8, 13, 16];

const shiftMapUI = {
  "49":"!", "50":"@", "51":"#", "52":"$", "53":"%", "54":"^", "55":"&", "56":"*", "57":"(", "48":")",
  "186":":","222":'"',"188":"<","190":">","191":"?"
};

const normalMapUI = {
  "49":"1","50":"2","51":"3","52":"4","53":"5","54":"6","55":"7","56":"8","57":"9","48":"0",
  "186":";","222":"'","188":",","190":".","191":"/"
};

function updateKeyboardUI() {
  const keys = document.querySelectorAll("#keyboard-container .key");
  keys.forEach(k => {
    const code = k.dataset.key;
    if (!code) return;

    // Skip functional keys
    if (["8", "13", "16"].includes(code)) return;

    // Letters (A-Z)
    if (code >= "65" && code <= "90") {
      k.textContent = (shiftActive || shiftLocked) 
        ? String.fromCharCode(parseInt(code))    // Uppercase
        : String.fromCharCode(parseInt(code) + 32); // Lowercase
    }
    // Numbers & symbols
    else if (normalMapUI[code]) {
      k.textContent = (shiftActive || shiftLocked) ? shiftMapUI[code] : normalMapUI[code];
    }
  });
}

function handleShiftUI(keyElem) {
  const now = Date.now();
  if (now - lastShiftTap < DOUBLE_TAP_THRESHOLD) {
    shiftLocked = !shiftLocked;    // toggle lock
    shiftActive = shiftLocked;     // active follows lock
  } else {
    // Single tap toggles shift only if not locked
    if (!shiftLocked) shiftActive = !shiftActive;
  }
  lastShiftTap = now;

  updateShiftKey(keyElem); // highlight Shift key
  updateKeyboardUI();      // update letter/symbol UI
}
updateKeyboardUI();
</script>
</body>
</html>
